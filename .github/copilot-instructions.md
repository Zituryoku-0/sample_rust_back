# Copilot Instructions (Rust Repository)

このリポジトリは Rust で実装するプロジェクトです。
Copilot は以下の規約・方針に従って、実装・修正・提案を行ってください。

---

## 0. 最重要ポリシー（必ず守る）
- レビューは日本語で記載すること。
- **コンパイルが通ること**を最優先する（`cargo check` が通る状態）。
- **rustfmt / clippy を前提**にする（標準的な Rust の流儀に寄せる）。
- 変更は **最小差分**・**意図が読み取れる命名**・**一貫した構成**で行う。
- 追加するコードには **理由のある設計**を入れる（「なぜそうするか」が説明できる状態）。

---

## 1. コーディングスタイル
- Edition: `2021` を前提（`Cargo.toml` に従う）。
- フォーマット: `cargo fmt` に従う（手動整形しない）。
- Lint: `cargo clippy --all-targets --all-features -D warnings` を意識。
- `unwrap()` / `expect()` は **テスト以外では原則禁止**。
  - 例外：起動時の「絶対に存在すべき設定」などで、メッセージ付き `expect("...")` を明確に使う場合のみ。
- `panic!` は原則禁止（到達不能なら `unreachable!()` を最小限）。

---

## 2. エラーハンドリング指針
- 公開API層（HTTPハンドラなど）では、ユーザーに返すエラーを **型で整理**する。
- 可能なら `thiserror` を使ってドメインエラーを定義し、境界で変換する。
- エラーには **文脈（context）** を入れる。
- `Result<T, E>` を返せる設計にし、例外的にログだけ出して握りつぶす実装は避ける。

---

## 3. モジュール構成（推奨）
- `main.rs`：起動・DI（設定読み込み、トレーシング初期化、サーバ起動）
- `app.rs`：ルーティング組み立て（axum Router など）
- `config/`：設定（env/ファイル）と初期化
- `routes/`：HTTPハンドラ（薄く保つ）
- `dto/`：リクエスト/レスポンス（serde）
- `domain/`：業務ロジック（HTTP/DBに依存させない）
- `infra/`：DB/外部APIなど（具体実装）
- `error.rs`：エラー型（API・ドメインの境界）

※実プロジェクトの構造が既にある場合は、既存の方針を優先して合わせる。

---

## 4. 非同期（tokio）運用
- 不必要に `spawn` しない。構造化された async の流れを優先。
- ブロッキング処理（重いCPU/同期I/O）は `spawn_blocking` を検討。
- タイムアウト・リトライなどは、責務を分離して共通化する。

---

## 5. Web API（axum 等）でのベストプラクティス
- ハンドラは「入力検証 → usecase 呼び出し → 返却整形」に徹し、ロジックを持たせない。
- DTO（外部I/F）とドメインモデル（内部）は **分ける**。
- ステータスコードとエラー返却の仕様を一貫させる（例：validation=400, not found=404, conflict=409, unexpected=500）。
- ルーティングは `app.rs` に集中させ、ハンドラ内で Router を組み立てない。

---

## 6. データ（DB）アクセス方針（採用技術に合わせる）
- 可能なら Repository/DAO を定義して、ドメイン層がクエリ実装に依存しないようにする。
- SQL 文字列の直書きは「境界（infra）」に閉じ込める。
- 返却の NULL/Optional は Rust の `Option<T>` で扱い、呼び出し側に押し付けない。

---

## 7. ロギング / トレーシング
- `tracing` を前提にする。
- request_id など、運用で追えるキーをログに含める。
- ログは「原因究明に必要な情報」を出し、個人情報・秘匿情報は出さない。

---

## 8. テスト方針
- ユニットテスト：ドメイン・usecase を中心に、小さく速く。
- 結合テスト：routes（HTTP）や DB 接続が絡むものは `tests/` に分離。
- 重要：テストは「正常系 + 境界値 + 異常系（入力不正・外部失敗）」を揃える。
- テストコードでは `unwrap()` は許容（ただし目的が明確な場合のみ）。

---

## 9. 依存関係の追加ルール
- 依存追加は慎重に。標準ライブラリで足りるなら追加しない。
- 追加する場合は「目的」「代替案」「採用理由」をコメントまたはPR説明に残せる形にする。

---

## 10. PR/レビューで Copilot が出すべき指摘の観点
- clippy で落ちる可能性（所有権/ライフタイム/不要 clone / needless borrow）
- エラー握りつぶし・unwrap の混入
- DTO とドメイン混在による責務肥大
- 非同期でのブロッキング混入
- ログに秘匿情報が出る可能性
- テスト不足（境界/異常系）

---

## 11. 生成コードの提示形式
- 変更提案は「ファイルパス」「差分」「理由」をセットで。
- 可能なら `cargo fmt` 後の形で提示する。
- 既存コードの流儀（命名・構造・error型）に合わせ、独自流儀を持ち込まない。

---